name: ci

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  # Keep this value in sync with rust-toolchain.toml.
  RUST_TOOLCHAIN: nightly-2026-02-10
  ZKSYNC_USE_CUDA_STUBS: "true"

jobs:
  lints:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: clippy,rustfmt,rust-src,llvm-tools-preview
      - name: Rustfmt
        run: cargo fmt --all -- --check
      - name: Clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: rust-src,llvm-tools-preview
      - uses: taiki-e/install-action@v2
        with:
          tool: nextest
      - name: Build
        run: cargo build --workspace
      - name: Test
        run: cargo nextest run --workspace

  cli-integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: rust-src,llvm-tools-preview
      - name: Install cargo-binutils
        run: cargo install cargo-binutils --locked
      - name: Install cargo-airbender
        run: cargo install --path crates/cargo-airbender --locked --force --debug
      - name: Run cargo-airbender integration flow
        run: |
          # TODO: this is a mess, but it's better than nothing -- to be properly refactored.
          tmp_dir="$(mktemp -d)"
          project_dir="$tmp_dir/smoke"

          cargo airbender new "$project_dir" --yes --name smoke --prover-backend dev --sdk-path "$PWD"
          cargo airbender build --project "$project_dir/guest"

          printf '00000001\n29000000\n' > "$tmp_dir/input.hex"

          cargo airbender run "$project_dir/guest/dist/app/app.bin" --input "$tmp_dir/input.hex"
          cargo airbender prove "$project_dir/guest/dist/app/app.bin" --input "$tmp_dir/input.hex" --output "$tmp_dir/proof.bin" --backend dev

          # Intentionally only verify command success and proof artifact presence for now.
          test -f "$tmp_dir/proof.bin"
